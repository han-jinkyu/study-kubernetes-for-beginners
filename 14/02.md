# 2. 퍼시스턴트 볼륨과 퍼시스턴트 볼륨 클레임

- 쿠버네티스에서 볼륨을 사용하는 구조는 2가지로 분리되어 있다.
    - 퍼시스턴트 볼륨(PersistentVolume)
    - 퍼시스턴트 볼륨 클레임(PersistentVolumeClaim)
- PV는 볼륨 그 자체이며, PVC는 사용자가 PV에 하는 요청이다.
- 쿠버네티스는 볼륨에 직접 파드를 할당하는 것이 아닌, 중간에 PVC를 두어 파드와 파드가 사용할 스토리지를 분리한 형태다.

```
# PV와 PVC의 생명주기

    -----> [ 프로비저닝(Provisioning) ] -------
    |                                       |/
[ 반환(Reclaiming) ]            [ 바인딩(Binding) ]
   /|                                       |
    ------------- [ 사용(Using) ] <-----------
```

## 2.1 프로비저닝

- PV를 만드는 단계다.
- 프로비저닝 방법에는 PV를 미리 만들고 사용하는 정적(static) 방법과 요청이 있을 때마다 만드는 동적(dynamic) 방법이 있다.
- 정적 프로비저닝은 클러스터 관리자가 미리 적정 용량의 PV를 만들어 두고 요청이 있으면 미리 만든 PV를 할당한다.
    - 사용할 수 있는 스토리지에 제한이 있을 경우 유용하다.
- 동적 프로비저닝은 사용자가 PVC를 거쳐서 PV를 요청할 때 생성해 제공한다.
- PVC는 동적 프로비저닝 떄 여러 스토리지 중 원하는 스토리지를 정의하는 스토리지 클래스(StorageClass)로 PV를 생성한다.

## 2.2 바인딩

- 프로비저닝으로 만든 PV를 PVC와 연결하는 단계다.
- PVC에서 원하는 스토리지의 용량과 접근 방법을 명시해서 요청하면 그에 맞는 PV가 할당된다.
- 할당 요청이 실패하면 원하는 PV가 생기 때까지 대기하다가 PVC에 바인딩 된다.
- PV와 PVC의 매핑은 1대1 관계다.

## 2.3 사용

- PVC는 파드에 설정되고 파드는 PVC를 볼륨으로 인식해서 사용한다.
- 할당된 PVC는 파드가 유지되는 동안엔 임의로 삭제할 수 없다. 이를 '사용 중인 스토리지 오브젝트 보호'라 한다.
- 파드가 사용 중인 PVC를 삭제하려고 하면 상태가 `Terminating`이지만 파드가 아직 사용하고 있다면 삭제되지 않고 남아 있다.

## 2.4 반환

- 사용이 끝난 PVC는 삭제되고 PV를 초기화(reclaim)하는 과정을 거치는데 이를 반환(reclaiming)이라 한다.
- 초기화 정책은 `Retain`, `Delete`, `Recycle`이 있다.

### Retain

- PV를 그대로 보존한다.
- PVC가 삭제되면 사용 중이던 PV는 해제(released) 상태라 아직 다른 PVC가 재사용할 수 없다.
- 이 PV를 재사용하려면 관리자가 다음 순서대로 직접 초기화해야 한다.
    1. PV 삭제. 만약 PV가 외부 스토리지와 연결됐다면 PV는 삭제되더라도 외부 스토리지의 볼륨은 그대로 남아 있다.
    2. 스토리지에 남은 데이터를 직접 정리한다.
    3. 남은 스토리지의 볼륨을 삭제하거나 재사용하려면 해당 볼륨을 이용하는 PV를 다시 만든다.

### Delete

- PV를 삭제하고 연결된 외부 스토리지 쪽 볼륨도 삭제한다.
- 프로비저닝 할 때 동적 볼륨 할당으로 생성된 PV는 기본 반환 정책이 `Delete`다.

### Recycle

- PV의 데이터를 삭제하고 다시 새로운 PVC에서 PV를 사용할 수 있게 한다.
- 특별한 파드를 만들고 데이터를 초기화 하는 기능도 있다.
- 하지만 PV의 데이터를 초기화 하는 여러 상황을 다 지원할 수 없다고 판단해 Deprecated 중인 정책이다.

-----
[HOME](./index.md)
