# 6. 잡

- 실행된 후 종료해야 하는 성격의 작업을 실행할 때 사용하는 컨트롤러다.
- 특정 개수만큼 파드를 정상적으로 실행 종료할 것을 보장한다.
- 잡을 이용하는 가장 단순한 상황은 잡이 파드 하나를 실행하고 파드가 정상적으로 종료됐는지 확인하는 것이다.
- 파드 실행 실패, 하드웨어 장애 발생, 노드 재시작 등 문제가 발생하면 다시 파드를 실행한다.
- 잡 하나가 파드를 여러 개 실행할 수도 있다.

## 6.1 잡 사용하기

- 원주율을 계산하는 간단한 펄(perl) 명령을 실행해본다.

```yaml
# job/job.yaml
apiVersion: batch/v1                # [1]
kind: Job
metadata:
  name: pi
spec:
  template:
    spec:
      containers:
      - name: pi
        image: perl
        command: ["perl", "-Mbignum=bpi", "-wle", "print bpi(2000)"]    # [2]
      restartPolicy: Never          # [3]
  backoffLimit: 4                   # [4]
```

- 위 코드를 살펴보면 다음과 같다.
    1. 잡이 사용하는 `.apiVersion`은 `batch/v1`이다.
    2. `.spec.template.spec.containers[].command`: 원주율을 계산하는 펄 명령
    3. `.spec.template.spec.restartPolicy`: `Never`를 설정해 파드가 항상 성공으로 끝나게 한다.
        - `OnFailure`도 설정할 수 있다. 뜻은 파드 안 컨테이너가 정상 종료되지 않았을 때 컨테이너를 다시 시작한다.
    4. `.spec.backoffLimit`: 잡 실행이 실패했을 때 자동으로 최대 몇 번까지 재시작할 것인지를 설정
        - 이를 파드 비정상 실행 종료의 백오프(backoff) 정책이라 한다.
        - 기본값은 6이다.
        - 보통 잡 컨트롤러가 재시작을 관리할 때마다 시간 간격을 늘린다.
        - 재시작하다가 파드 실행이 완료되면 재시도 횟수는 0으로 초기화된다.
- 위 템플릿을 적용하고 잡 상태를 확인한다.

```zsh
$ kubectl apply -f job.yaml
job.batch/pi created

$ kubectl describe job pi
Name:           pi
Namespace:      default
Selector:       controller-uid=481a1904-435b-4d8b-9786-d649330217df
Labels:         controller-uid=481a1904-435b-4d8b-9786-d649330217df
                job-name=pi
Annotations:    <none>
Parallelism:    1
Completions:    1
Start Time:     Sat, 22 May 2021 17:59:53 +0900
Completed At:   Sat, 22 May 2021 18:00:52 +0900
Duration:       59s
Pods Statuses:  0 Running / 1 Succeeded / 0 Failed
# (...)
```

- `Start Time`, `Completed At`, `Duration`, `Pods Statuses` 항목을 확인해본다.
- 원주율 계산 결과는 `kubectl logs`로 확인한다.

```zsh
$ kubectl get pods
NAME                                READY   STATUS      RESTARTS   AGE
pi-sptpw                            0/1     Completed   0          3m15s

$ kubectl logs pi-sptpw
3.1415926535897932384626433832795028841971...
```

## 6.2 잡 병렬성 관리

- 잡 하나가 몇 개의 파드를 동시에 실행할지를 **잡 병렬성**이라 한다.
- `.spec.parallelism` 필드에 설정할 수 있다.
- 기본값은 1이며, 0으로 설정하면 잡을 정지할 수 있다.
- 단 병렬성 옵션을 지정해도 다음과 같은 이유로 지정된 값보다 적게 파드를 실행할 수 있다.
    - 정상 완료되는 잡의 개수를 고정하려면, 병렬로 실행되는 실제 파드의 개수가 정상 완료를 기다리며 남아 있는 잡의 개수를 넘지 않아야 한다.
    - 워크 큐용 잡에서는 파드 하나가 정상적으로 완료됐을 때 새로운 파드가 실행되지 않는다. 단, 현재 실행 중인 잡은 완료될 때까지 실행될 수 있다.
    - 잡 컨트롤러가 반응하지 못할 때도 있다.
    - 잡 컨트롤러가 자원 부족이나 권한 부족을 이유로 파드를 실행하지 못할 때도 있다.
    - 잡에서 실행시킨 파드가 너무 많이 실패하면 잡 컨트롤러가 새로운 파드 생성을 제한할 수 있다.
    - 파드가 그레이스풀하게 종료되었을 때도 있다.

## 6.3 잡의 종류

- 잡의 종류로는 다음이 있다.
    - 단일 잡
    - 완료된 잡 개수가 있는 병렬 잡
    - 워크 큐가 있는 병렬 잡

### 단일 잡의 특징

- 파드 하나만 실행된다. 파드가 정상적으로 실행 종료되면 잡 실행을 완료한다.
- `.spec.completions`, `.spec.parallelism` 필드를 설정하지 않는다.
    - 단일 파드만 실행되기에 기본값 1로 설정되기 때문이다.

### 완료 개수가 있는 병렬 잡의 특징

- `.spec.completions` 필드를 양수 값으로 설정한다.
- `.spec.parallelism` 필드는 설정하지 않거나 기본값인 1로 설정해야 한다.

### 워크 큐가 있는 병렬 잡의 특징

- `.spec.completions` 필드는 설정하지 않고, `.spec.parallelism` 필드는 양수로 설정한다.
- `.spec.completions` 필드 값을 설정하지 않으면 기본값이 `.spec.parallelism` 필드와 동일하게 설정된다.
- 각 파드는 정상적으로 실행 종료됐는지를 독립적으로 결정할 수 있다. 대기열에 있는 작업들이 모두 동시에 실행될 수도 있다는 뜻이다.
- 파드 하나라도 정상적으로 실행 종료되면 새로운 파드가 실행되지 않는다.
- 최소한 파드 하나가 정상적으로 종료된 후 모든 파드가 실행 종료되면, 잡이 정상적으로 종료된다.
- 일단 파드 하나가 정상적으로 종료되면 다른 파드는 더 이상 동작하지 않거나 어떤 작업 처리 결과를 내지 않는다. 모든 파드는 모두 종료 과정을 실행한다.

## 6.4 비정상적으로 실행 종료된 파드 관리하기

- 파드 안에 비정상적으로 실행 종료된 컨테이너가 있을 때를 대비해 `.spec.template.spec.restartPolicy`를 지정할 수 있다.
- 컨테이너가 비정상 실행 종료될 때 다양한 이유로 종료되는데, 이때 상기 필드를 `OnFailure`로 설정하면 파드는 원래 실행 중이던 노드에서 컨테이너를 재시작한다.
    - 이렇게 파드를 실행할 때는 앱 컨테이너가 재시작되는 상황을 고려해야 한다.
- 컨테이너 재시작 정책을 `Never`로 설정해서 재시작을 막을 수도 있다.
    - 재시작을 막은 후에는 잡에서 새로운 파드를 실행한다.
    - 이렇게 파드가 재시작되는 상황도 앱 컨테이너에서 처리해야 한다.
- 이전 파드에서 처리 중이던 상태를 인식해서 해당 상태부터 재시작하거나 아니면 초기화하고 처음부터 다시 시작할 수 있어야 한다.
- 만약 `.spec.parallelism`, `.spec.completions`가 1이고, `.spec.template.spec.restartPolicy`가 `Never`라면, 같은 프로그램이 2번 실행될 수 있다.
    - 이때는 `.spec.parallelism`, `.spec.completions`를 1보다 크게 설정하면 여러 파드가 실행될 수 있다.
- 앱은 이런 상황을 고려해서 처리할 수 있게 설계해야 한다.

## 6.5 잡 종료와 정리

- 잡이 정상적으로 실행 종료되면 파드가 새로 생성되지도 삭제되지 않는다. 또한 잡도 남아있다.
- 파드가 잡이 삭제되지 않고 남아 있으면 로그에서 에러나 경고를 확인할 수 있고, 잡의 상태도 계속 확인할 수 있다.
- 이를 이용해 필요한 분석도 가능하다.
- 특정 시간을 지정해 잡 실행을 종료하려면 `.spec.activeDeadlineSeconds` 필드에 시간을 지정하면 된다.
    - 지정된 시간에 해당 잡 실행을 강제로 끝내면서 모든 파드 실행도 종료한다.
    - 시간 지정으로 잡이 종료되면 종료 이유로 `reason:DeadlineExceeded`로 표시된다.
- 잡 삭제는 사용자가 직접 해야 한다.

## 6.6 잡 패턴

- 잡에서 파드를 병렬로 실행했을 때 파드 각각이 서로 통신하면서 동작하진 않는다.
- 각 파드는 독립적인 것이 전제이므로, 메일 발송이나 파일 변환 등은 분산 작업이기에 한꺼번에 실행해야 해서 제대로 동작하지 않는다는 의미다.
- 잡의 일반적인 사용 패턴은 다음과 같다.
    - 작업마다 잡을 하나씩 생성해 사용하는 것보단 모든 작업을 관리하는 잡 하나를 사용한다.
        - 잡을 생성하는 건 오버헤드가 크다.
        - 작업이 많아질수록 잡 하나가 여러 개 작업을 처리하는 것이 좋다.
    - 작업 개수만큼 파드를 생성하는 것보다 파드 하나가 여러 작업을 처리하는 것이 좋다.
        - 파드를 생성하는 오버헤드도 크다.
        - 따라서 작업이 많아질수록 파드 하나가 여러 작업을 처리하는 것이 유리하다.
    - 워크 큐를 사용한다면 카프카나 RabbitMQ 같은 큐 서비스로 워크 큐를 구현하도록 기존 프로그램이나 컨테이너를 수정해야 한다.
        - 워크 큐를 사용하지 않으면 그냥 기본 설정 그대로 컨테이너를 사용하므로 비효율적이다.

-----
[HOME](./index.md)
