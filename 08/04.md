# 4. 무중단 배포를 할 때 주의할 점

- 인그레스를 이용해 외부에서 컨테이너에 접근할 수 있는 경우, 새로운 버전의 컨테이너를 배포할 땐 어떻게 할까?
- 먼저 파드가 배포될 때 어떻게 되는지 살펴본다.
    - 새로운 파드(v2)가 생성되고 헬스 체크가 성공한 후 트래픽을 파드(v2) 쪽으로 보낸다.
    - 그 후 파드(v1) 쪽으로 보내던 트래픽을 중단한 후 파드(v1)을 제거한다.
- 이러한 방식을 응용하면 무중단으로 컨테이너를 배포할 수 있다.

## 4.1 maxSurge와 maxUnavailable 필드 설정

- 파드 관리를 `RollingUpdate`로 설정했을 때, `.maxSurge`와 `.maxUnavailable` 필드 설정이 필요하다.
    - `.maxSurge`: 디플로이먼트에 설정된 기본 파드 개수에 여분의 파드를 몇 개 더 추가할 수 있는지
    - `.maxUnavailable`: 디플로이먼트를 업데이트하는 동안 몇 개의 파드를 이용할 수 없어도 되는지
- 이 필드 2개의 설정을 운영 중인 서비스의 특성에 맞게 적절히 조정해야 항상 일정 개수 이상의 파드를 이용할 수 있다.
    - 그 결과 컨테이너 배포 중 트래픽 유실이 없다.
- 두 필드 값을 한꺼번에 0으로 설정해서는 안 된다.
    - 파드가 없을 수도 있기 때문이다.

## 4.2 파드가 readinessProbe를 지원하는지 확인

- 무중단 배포에서 신경 써서 봐야 할 프로브는 `readinessProbe`다.
    - 실제로 컨테이너가 서비스 요청을 처리할 준비가 되었는지 진단한다.
- `readinessProbe`가 OK 상태여야 해당 파드와 연결된 서비스에 파드의 IP가 추가되고 트래픽을 받는다.
- `.spec.minReadySeconds` 필드는 파드가 준비 상태일 때까지 최소 대기 시간으로, 기본 값이 0이다.
    - 파드가 실행된 후 설정된 시간 동안은 트래픽을 받지 않는다.
- 그러므로 `readinessProbe`를 지원하기 어려운데 초기화가 길다면 위 필드 설정은 유용하다.
- 하지만 `readinessProbe`가 끝나면 `.spec.minReadySeconds` 필드에 설정된 시간이 아직 남았더라도 무시하고 트래픽을 보낸다.

## 4.3 쿠버네티스와 컨테이너 안에 그레이스풀 종료 설정

- `kubelet`은 새 파드가 실행되고 이전 파드를 종료할 때 파드에 `SIGTERM` 신호를 먼저 보낸다.
- 무중단 배포를 하려면 컨테이너에서 `SIGTERM` 신호를 받았을 때 기존 요청만 처리하고 새 요청을 받지 않는 그레이스풀 종료가 설정되어야 한다.
- 설정되지 않으면 종료된 파드로 트래픽이 보내져, 인그레스 컨트롤러 설정이 갱신되기 전까지 에러가 발생한다.
- `kubelet`에서 파드에 `SIGTERM` 신호를 보낸 후 일정 시간 그레이스풀 종료가 되지 않으면 강제로 `SIGKILL` 신호를 보내서 파드를 종료한다.
    - 대기 시간은 `.terminationGradePeriodSeconds`로 설정할 수 있고, 기본값은 30초다.
- 파드에 그레이스풀 종료를 설정하지 못할 떄가 있다.
    - 이때는 프리스톱 훅(prestop hook)을 이용할 수 있다.
- 파드 생명 주기 중 훅(hook)을 설정할 수 있다.
    - 파드가 실행된 직후 실행하는 포스트스타트 훅(poststart hook)과 종료 직전에 실행하는 프리스톱 훅이다.
- 프리스톱 훅은 파드에서 `SIGTERM` 신호를 보내기 전에 실행된다.
    - 따라서 컨테이너와 별개로 그레이스풀 종료와 같은 효과를 낼 수 있다.
- 또한 프리스톱 훅의 실행이 완료되기 전엔 컨테이너에 `SIGTERM` 신호를 보내지 않는다.
    - 따라서 컨테이너 설정과 별개로 종료되기 전 대기 시간도 설정할 수 있다.
- 하지만 프리스톱 훅으로 대기 시간을 설정해도 `.terminationGracePeriodSeconds` 필드에 설정한 대기 시간을 초과하면 프로세스 종료가 발생하므로 염두해야 한다.

-----
[HOME](./index.md)
